{
  try {
    IoBridge.connect(fd,socksGetServerAddress(),socksGetServerPort());
  }
 catch (  Exception e) {
    throw new IOException("Unable to connect to SOCKS server",e);
  }
  if (lastConnectedAddress == null) {
    throw new SocketException("Invalid SOCKS client");
  }
  socksSendRequest(Socks4Message.COMMAND_BIND,lastConnectedAddress,lastConnectedPort);
  Socks4Message reply=socksReadReply();
  if (reply.getCommandOrResult() != Socks4Message.RETURN_SUCCESS) {
    throw new IOException(reply.getErrorString(reply.getCommandOrResult()));
  }
  if (reply.getIP() == 0) {
    address=socksGetServerAddress();
  }
 else {
    byte[] replyBytes=new byte[4];
    Memory.pokeInt(replyBytes,0,reply.getIP(),ByteOrder.BIG_ENDIAN);
    address=InetAddress.getByAddress(replyBytes);
  }
  localport=reply.getPort();
}
