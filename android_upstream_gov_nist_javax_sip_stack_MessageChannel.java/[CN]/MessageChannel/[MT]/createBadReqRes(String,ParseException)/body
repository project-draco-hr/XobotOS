{
  StringBuffer buf=new StringBuffer(512);
  buf.append("SIP/2.0 400 Bad Request (" + pe.getLocalizedMessage() + ')');
  if (!copyViaHeaders(badReq,buf))   return null;
  if (!copyHeader(CSeqHeader.NAME,badReq,buf))   return null;
  if (!copyHeader(CallIdHeader.NAME,badReq,buf))   return null;
  if (!copyHeader(FromHeader.NAME,badReq,buf))   return null;
  if (!copyHeader(ToHeader.NAME,badReq,buf))   return null;
  int toStart=buf.indexOf(ToHeader.NAME);
  if (toStart != -1 && buf.indexOf("tag",toStart) == -1) {
    buf.append(";tag=badreq");
  }
  ServerHeader s=MessageFactoryImpl.getDefaultServerHeader();
  if (s != null) {
    buf.append("\r\n" + s.toString());
  }
  int clength=badReq.length();
  if (!(this instanceof UDPMessageChannel) || clength + buf.length() + ContentTypeHeader.NAME.length()+ ": message/sipfrag\r\n".length()+ ContentLengthHeader.NAME.length() < 1300) {
    ContentTypeHeader cth=new ContentType("message","sipfrag");
    buf.append("\r\n" + cth.toString());
    ContentLength clengthHeader=new ContentLength(clength);
    buf.append("\r\n" + clengthHeader.toString());
    buf.append("\r\n\r\n" + badReq);
  }
 else {
    ContentLength clengthHeader=new ContentLength(0);
    buf.append("\r\n" + clengthHeader.toString());
  }
  return buf.toString();
}
