{
  int index=position.getIndex(), length=string.length(), count=1;
  boolean quote=false;
  while (index < length) {
    char ch=string.charAt(index++);
    if (ch == '\'') {
      quote=!quote;
    }
    if (!quote) {
      if (ch == stop) {
        count--;
      }
      if (count == 0) {
        position.setIndex(index);
        return true;
      }
      if (ch == start) {
        count++;
      }
    }
    buffer.append(ch);
  }
  throw new IllegalArgumentException("Unmatched braces in the pattern");
}
